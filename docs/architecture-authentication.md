# Authentication and Authorization

![architecture](images/architecture.png)

### Possible cases

- For a standard Jitsi room
  - A Keycloak user joins the meeting
  - A guest user joins the meeting
- For a Jitsi room created by Element Jitsi widget
  - A Matrix admin joins the meeting
  - A Matrix member joins the meeting
  - A guest user joins the meeting
  - A Keycloak user joins the meeting

### Authentication flow

1. The web client requests to join the meeting\
   _>> (1)_
2. If there is no token, `Nginx` routes the client to the static `redirect.html`
   page\
   _>> (2)_
3. `redirect.html` redirects the client to `jitsi-keycloak-adapter` after
   parsing the request link\
   _>> redirection_\
   _>> (1) >> (3)_
4. `jitsi-keycloak-adapter` creates the `OIDC` request and redirects the client
   to `Keycloak`\
   _>> redirection_\
   _>> (4)_
5. The client tries to get the short-term authorization code from `Keycloak` and
   comes back to `Nginx` again\
   _>> (1)_
6. If there is no short-term authorization code, the client goes to the waiting
   room as `guest`\
   _>> (2)_\
   _>> (1) >> (6)_
7. If there is a short-term authorization code, the request goes to
   `jitsi-keycloak-adapter`\
   _>> (2) >> redirection_\
   _>> (1) >> (3)_
8. If the short-term authorization code is valid _(5)_, `jitsi-keycloak-adapter`
   generates a token for Jitsi session and redirects the client to Jitsi with a
   token\
   _>> redirection_
9. If the short-term authorization code is invalid _(5)_,
   `jitsi-keycloak-adapter` redirects the client to Jitsi without a token\
   _>> redirection_
10. If there is no token at this time, the client goes to the waiting room as
    `guest`\
    _>> (1) >> (2)_\
    _>> (1) >> (6)_
11. If there is a token at this time, the client goes to the meeting as
    `moderator`\
    _parallel pipelines:_\
    _>> (1) >> (2)_\
    _>> (1) >> (6)_\
    _>> (1) >> (7)_\
    _>> (8)_

### Matrix case

If the Jitsi room is created by Element Jitsi widget and the client is the
Matrix user joining the meeting through Element Jitsi widget then the client has
already a token generated by the widget. So, Matrix users start the
authentication flow at step `11` since they have already a token.

By default, anyone with a token becomes `moderator` in the meeting but this is
not what we want for the Matrix case. Therefore
[matrix_affiliation](https://github.com/jitsi-contrib/prosody-plugins/blob/main/auth_hybrid_matrix_token/mod_matrix_affiliation.lua)
module downgrades the affiliation level of the participant if she is not an
admin in the related Matrix room.

This is also true for Keycloak users joining the meeting created by the widget.
Even they are trusted users, they become `member` for Matrix meetings.

### Guest case

Guest users are user who do not have a Keycloak account, Matrix account and a
valid token. Guest users go to the waiting room if the meeting is not created
yet and join the room after it is created by a trusted user.

It is possible to completely disable guest login by setting some configuration
parameters of the deployment or to enable the lobby to allow moderator to manage
guest logins.

### Related links

- [Jitsi Keycloak Adapter](https://github.com/nordeck/jitsi-keycloak-adapter)
- [Hybrid Matrix Token](https://github.com/jitsi-contrib/prosody-plugins/tree/main/auth_hybrid_matrix_token)
